#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

timezone=$(timedatectl show --value --property=Timezone)
admin_mail=$(ynh_user_get_info --username="$admin" --key=mail)
cwa_release=$(ynh_app_upstream_version)

#=================================================
# STOP SYSTEMD SERVICE
#=================================================
ynh_script_progression "Stopping $app's systemd service..."

ynh_systemctl --service="${app}" --action="stop"

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression "Setting up source files..."

#Set settings constant initializer of the app (variables aren’t updated otherwise)
ynh_config_add --template="../patches/cwa/ub.py.patch.src" --destination="../patches/cwa/ub.py.patch"

ynh_script_progression "Setting up cwa..."
ynh_setup_source --dest_dir="$install_dir/cwa" --source_id="cwa" --full_replace=1

# Install kepubify converter
ynh_script_progression "Setting up kepubify..."
ynh_setup_source --dest_dir="$install_dir/tools" --source_id="kepubify" --full_replace=1

# Install Calibre
ynh_script_progression "Setting up Calibre..."
ynh_setup_source --dest_dir="$install_dir/tools/calibre" --source_id="calibre"

pushd "$install_dir/tools/calibre"
	tar -xvf calibre.txz
popd

chown -R $app:$app $install_dir
chmod -R 770 $install_dir/tools

#=================================================
# UPDATE FILES AND DIRECTORIES
#=================================================
ynh_script_progression "Updating files and directory..."

#build multimedia directory
ynh_multimedia_build_main_dir
ynh_multimedia_addaccess $app

#=================================================
# APP INITIAL CONFIGURATION
#=================================================
ynh_script_progression "Adding $app's configuration files..."

ynh_config_add --template=".env" --destination="$install_dir/.env"

#=================================================
# NGINX CONFIGURATION
#=================================================
ynh_script_progression "Updating nginx web server configuration..."

ynh_script_progression "Upgrading nginx web server configuration..."
#Cannot use empty string for X-script-name, causes an issue in the python prg
#https://github.com/janeczku/calibre-web/wiki/Setup-Reverse-Proxy#nginx
if [ $path = "/" ] ; then
	ynh_replace --match="        proxy_set_header	X-Script-Name		__PATH__;" \
	            --replace="        proxy_set_header	X-Script-Name		/__PATH__;" \
	            --file="../conf/nginx.conf"
fi

#Setting the proxy authentication in case calibre is not open to visitor.
#https://github.com/janeczku/calibre-web/wiki/Setup-Reverse-Proxy#login-via-header-from-upstream-authentication-source
if $(ynh_permission_has_user --permission=main --user=visitors); then
	sqlite3 $install_dir/config/app.db "UPDATE settings SET config_reverse_proxy_login_header_name='', config_allow_reverse_proxy_header_login=0 WHERE ID=1;"
	ynh_replace --match="        proxy_set_header	X-Remote-User" \
	            --replace="#       proxy_set_header	X-Remote-User" \
	            --file="../conf/nginx.conf"
else
	sqlite3 $install_dir/config/app.db "UPDATE settings SET config_reverse_proxy_login_header_name='X-Remote-User', config_allow_reverse_proxy_header_login='True', config_allow_reverse_proxy_header_login=1 WHERE ID=1;"
fi

# Create a dedicated nginx config
ynh_config_add_nginx

#=================================================
# INSTALL DEPENDENCIES
#=================================================
ynh_script_progression "Installing pip requirements..."

pushd "$install_dir/cwa"
	ynh_exec_as_app python3 -m venv "$install_dir/cwa/venv"
	ynh_hide_warnings ynh_exec_as_app "$install_dir/cwa/venv/bin/pip" install --upgrade wheel pip setuptools
	ynh_hide_warnings ynh_exec_as_app "$install_dir/cwa/venv/bin/pip" install --no-cache-dir --upgrade --use-pep517 -r "$install_dir/cwa/requirements.txt"
	ynh_hide_warnings ynh_exec_as_app "$install_dir/cwa/venv/bin/pip" install --no-cache-dir --upgrade --use-pep517 -r "$install_dir/cwa/optional-requirements.txt"

	find cps -type f -name "*.py" -exec sed -i 's#/app/calibre-web-automated#'"$install_dir/cwa"'#g' {} \;
	find scripts -type f -name "*.py" -exec sed -i 's#/app/calibre-web-automated#'"$install_dir/cwa"'#g' {} \;

	# Compile translations, otherwise we only have English
	ynh_hide_warnings bash scripts/compile_translations.sh
popd

chmod +x "$install_dir/cwa/scripts/"*.sh || true
chmod +x "$install_dir/cwa/scripts/"*.py || true
chmod 775 "$install_dir/cwa/cps/"*.py || true

ynh_script_progression "Starting patching operations..."

_ynh_patch_cwa

ynh_script_progression "Creating koplugin.zip from KOReader plugin folder......"

 if [ -d "$install_dir/cwa/koreader/plugins/cwasync.koplugin" ]; then \
    cd $install_dir/cwa/koreader/plugins && \
    # Calculate digest of all files in the plugin for debugging purposes
    PLUGIN_DIGEST=$(find cwasync.koplugin -type f -name "*.lua" -o -name "*.json" | sort | xargs sha256sum | sha256sum | cut -d' ' -f1) && \
    echo "Plugin digest: $PLUGIN_DIGEST" && \
    # Create a file named after the digest inside the plugin folder
    echo "Plugin files digest: $PLUGIN_DIGEST" > cwasync.koplugin/${PLUGIN_DIGEST}.digest && \
    echo "Build date: $(date)" >> cwasync.koplugin/${PLUGIN_DIGEST}.digest && \
    echo "Files included:" >> cwasync.koplugin/${PLUGIN_DIGEST}.digest && \
    find cwasync.koplugin -type f -name "*.lua" -o -name "*.json" | sort >> cwasync.koplugin/${PLUGIN_DIGEST}.digest && \
    zip -r koplugin.zip cwasync.koplugin/ && \
    echo "Created koplugin.zip from cwasync.koplugin folder with digest file: ${PLUGIN_DIGEST}.digest"; \
  else \
    echo "Warning: cwasync.koplugin folder not found, skipping zip creation"; \
  fi && \
  	# Move koplugin.zip to static directory
  if [ -f "install_dir/cwa/koreader/plugins/koplugin.zip" ]; then \
    mkdir -p $install_dir/cwa/cps/static && \
    cp $install_dir/cwa/koreader/plugins/koplugin.zip $install_dir/cwa/cps/static/ && \
    echo "Moved koplugin.zip to static directory"; \
  else \
    echo "Warning: koplugin.zip not found, skipping move to static directory"; \
  fi && \

#=================================================
# SETUP LOGROTATE
#=================================================

# Use logrotate to manage application logfile(s)
ynh_config_add_logrotate "$log_file"
ynh_config_add_logrotate "$access_log_file"

#=================================================
# SETUP FAIL2BAN
#=================================================
ynh_script_progression "Configuring Fail2Ban..."

# Make sure a log file exists (mostly for CI tests)
 if [ ! -f "$log_file" ]; then
	touch "$log_file"
	chown $app: "$log_file"
fi

# Create a dedicated Fail2Ban config
ynh_config_add_fail2ban --logpath="$log_file" --failregex="^.*LDAP Login failed for user .* IP-address: <HOST>.*$"

#=================================================
# REAPPLY SYSTEM CONFIGURATION
#=================================================

# Create a dedicated systemd config
ynh_config_add_systemd --service="${app}" --template="cwa.service"

yunohost service add "${app}" --description="CWA Browse eBook on the web" --log="$log_file"

#=================================================
# STARTING APP
#=================================================
ynh_script_progression "Start $app..."

ynh_systemctl --service="${app}" --action="start" --wait_until="Starting Gevent server on" -t 60

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Upgrade of $app completed"
